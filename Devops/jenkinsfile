pipeline{
agent any
tools{
     maven 'maven 3.9.5'
     }
stages{
      stage('Compilar'){
            steps{
                  echo "compilando..." 
                  sh "mvn clean compile"
                 } 

                         }
      stage('Pruebas') {
            steps{
                   echo "Ejecutando pruebas..."
                   sh "mvn test -Dspring.profiles.active=test -Dspring.data.mongodb.uri=mongodb://mongodb:27017/seguridad_test"
                  }

                  post{
                   success{
                         junit "target/surefire-reports/*.xml"  
                         }
                     }
                       }
      
      stage('Análisis de Código Estático') {
           steps{
                withSonarQubeEnv('sonarqube'){
                               sh "mvn sonar:sonar \
                                    -Dsonar.projectKey=curso-devops-sonar \
                                    -Dsonar.projectName=curso-devops-sonar \
                                    -Dsonar.projectVersion=1.0 \
                                    -Dsonar.sources=. \
                                    -Dsonar.java.binaries=. \
                                    -Dsonar.language=java \
                                    -Dsonar.sourceEncoding=UTF-8 \
                                    -Dsonar.token=squ_93a3931f3a3559b2bae55566668b5b044b8749ad \
                                    -Dsonar.host.url=http://172.19.0.3:9000/"
                      }
                  }

             
               }
            stage('Empaquetar') {
                       steps {sh 'mvn package'
                            }
                                }
              
      } 
     }
      